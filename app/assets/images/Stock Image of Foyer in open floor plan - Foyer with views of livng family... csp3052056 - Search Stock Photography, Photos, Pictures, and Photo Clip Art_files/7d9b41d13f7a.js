(function(factory){"use strict";if(typeof exports==='object'){module.exports=factory(window.jQuery);}else if(typeof define==='function'&&define.amd){define(['jquery'],factory);}else if(window.jQuery&&!window.jQuery.fn.colorpicker){factory(window.jQuery);}}
(function($){'use strict';var Color=function(val,customColors){this.value={h:0,s:0,b:0,a:1};this.origFormat=null;if(customColors){$.extend(this.colors,customColors);}
if(val){if(val.toLowerCase!==undefined){val=val+'';this.setColor(val);}else if(val.h!==undefined){this.value=val;}}};Color.prototype={constructor:Color,colors:{"aliceblue":"#f0f8ff","antiquewhite":"#faebd7","aqua":"#00ffff","aquamarine":"#7fffd4","azure":"#f0ffff","beige":"#f5f5dc","bisque":"#ffe4c4","black":"#000000","blanchedalmond":"#ffebcd","blue":"#0000ff","blueviolet":"#8a2be2","brown":"#a52a2a","burlywood":"#deb887","cadetblue":"#5f9ea0","chartreuse":"#7fff00","chocolate":"#d2691e","coral":"#ff7f50","cornflowerblue":"#6495ed","cornsilk":"#fff8dc","crimson":"#dc143c","cyan":"#00ffff","darkblue":"#00008b","darkcyan":"#008b8b","darkgoldenrod":"#b8860b","darkgray":"#a9a9a9","darkgreen":"#006400","darkkhaki":"#bdb76b","darkmagenta":"#8b008b","darkolivegreen":"#556b2f","darkorange":"#ff8c00","darkorchid":"#9932cc","darkred":"#8b0000","darksalmon":"#e9967a","darkseagreen":"#8fbc8f","darkslateblue":"#483d8b","darkslategray":"#2f4f4f","darkturquoise":"#00ced1","darkviolet":"#9400d3","deeppink":"#ff1493","deepskyblue":"#00bfff","dimgray":"#696969","dodgerblue":"#1e90ff","firebrick":"#b22222","floralwhite":"#fffaf0","forestgreen":"#228b22","fuchsia":"#ff00ff","gainsboro":"#dcdcdc","ghostwhite":"#f8f8ff","gold":"#ffd700","goldenrod":"#daa520","gray":"#808080","green":"#008000","greenyellow":"#adff2f","honeydew":"#f0fff0","hotpink":"#ff69b4","indianred":"#cd5c5c","indigo":"#4b0082","ivory":"#fffff0","khaki":"#f0e68c","lavender":"#e6e6fa","lavenderblush":"#fff0f5","lawngreen":"#7cfc00","lemonchiffon":"#fffacd","lightblue":"#add8e6","lightcoral":"#f08080","lightcyan":"#e0ffff","lightgoldenrodyellow":"#fafad2","lightgrey":"#d3d3d3","lightgreen":"#90ee90","lightpink":"#ffb6c1","lightsalmon":"#ffa07a","lightseagreen":"#20b2aa","lightskyblue":"#87cefa","lightslategray":"#778899","lightsteelblue":"#b0c4de","lightyellow":"#ffffe0","lime":"#00ff00","limegreen":"#32cd32","linen":"#faf0e6","magenta":"#ff00ff","maroon":"#800000","mediumaquamarine":"#66cdaa","mediumblue":"#0000cd","mediumorchid":"#ba55d3","mediumpurple":"#9370d8","mediumseagreen":"#3cb371","mediumslateblue":"#7b68ee","mediumspringgreen":"#00fa9a","mediumturquoise":"#48d1cc","mediumvioletred":"#c71585","midnightblue":"#191970","mintcream":"#f5fffa","mistyrose":"#ffe4e1","moccasin":"#ffe4b5","navajowhite":"#ffdead","navy":"#000080","oldlace":"#fdf5e6","olive":"#808000","olivedrab":"#6b8e23","orange":"#ffa500","orangered":"#ff4500","orchid":"#da70d6","palegoldenrod":"#eee8aa","palegreen":"#98fb98","paleturquoise":"#afeeee","palevioletred":"#d87093","papayawhip":"#ffefd5","peachpuff":"#ffdab9","peru":"#cd853f","pink":"#ffc0cb","plum":"#dda0dd","powderblue":"#b0e0e6","purple":"#800080","red":"#ff0000","rosybrown":"#bc8f8f","royalblue":"#4169e1","saddlebrown":"#8b4513","salmon":"#fa8072","sandybrown":"#f4a460","seagreen":"#2e8b57","seashell":"#fff5ee","sienna":"#a0522d","silver":"#c0c0c0","skyblue":"#87ceeb","slateblue":"#6a5acd","slategray":"#708090","snow":"#fffafa","springgreen":"#00ff7f","steelblue":"#4682b4","tan":"#d2b48c","teal":"#008080","thistle":"#d8bfd8","tomato":"#ff6347","turquoise":"#40e0d0","violet":"#ee82ee","wheat":"#f5deb3","white":"#ffffff","whitesmoke":"#f5f5f5","yellow":"#ffff00","yellowgreen":"#9acd32","transparent":"transparent"},_sanitizeNumber:function(val){if(typeof val==='number'){return val;}
if(isNaN(val)||(val===null)||(val==='')||(val===undefined)){return 1;}
if(val.toLowerCase!==undefined){return parseFloat(val);}
return 1;},isTransparent:function(strVal){if(!strVal){return false;}
strVal=strVal.toLowerCase().trim();return(strVal==='transparent')||(strVal.match(/#?00000000/))||(strVal.match(/(rgba|hsla)\(0,0,0,0?\.?0\)/));},rgbaIsTransparent:function(rgba){return((rgba.r===0)&&(rgba.g===0)&&(rgba.b===0)&&(rgba.a===0));},setColor:function(strVal){strVal=strVal.toLowerCase().trim();if(strVal){if(this.isTransparent(strVal)){this.value={h:0,s:0,b:0,a:0};}else{this.value=this.stringToHSB(strVal)||{h:0,s:0,b:0,a:1};}}},stringToHSB:function(strVal){strVal=strVal.toLowerCase();var alias;if(typeof this.colors[strVal]!=='undefined'){strVal=this.colors[strVal];alias='alias';}
var that=this,result=false;$.each(this.stringParsers,function(i,parser){var match=parser.re.exec(strVal),values=match&&parser.parse.apply(that,[match]),format=alias||parser.format||'rgba';if(values){if(format.match(/hsla?/)){result=that.RGBtoHSB.apply(that,that.HSLtoRGB.apply(that,values));}else{result=that.RGBtoHSB.apply(that,values);}
that.origFormat=format;return false;}
return true;});return result;},setHue:function(h){this.value.h=1-h;},setSaturation:function(s){this.value.s=s;},setBrightness:function(b){this.value.b=1-b;},setAlpha:function(a){this.value.a=parseInt((1-a)*100,10)/100;},toRGB:function(h,s,b,a){if(!h){h=this.value.h;s=this.value.s;b=this.value.b;}
h*=360;var R,G,B,X,C;h=(h%360)/60;C=b*s;X=C*(1-Math.abs(h%2-1));R=G=B=b-C;h=~~h;R+=[C,X,0,0,X,C][h];G+=[X,C,C,X,0,0][h];B+=[0,0,X,C,C,X][h];return{r:Math.round(R*255),g:Math.round(G*255),b:Math.round(B*255),a:a||this.value.a};},toHex:function(h,s,b,a){var rgb=this.toRGB(h,s,b,a);if(this.rgbaIsTransparent(rgb)){return'transparent';}
return'#'+((1<<24)|(parseInt(rgb.r)<<16)|(parseInt(rgb.g)<<8)|parseInt(rgb.b)).toString(16).substr(1);},toHSL:function(h,s,b,a){h=h||this.value.h;s=s||this.value.s;b=b||this.value.b;a=a||this.value.a;var H=h,L=(2-s)*b,S=s*b;if(L>0&&L<=1){S/=L;}else{S/=2-L;}
L/=2;if(S>1){S=1;}
return{h:isNaN(H)?0:H,s:isNaN(S)?0:S,l:isNaN(L)?0:L,a:isNaN(a)?0:a};},toAlias:function(r,g,b,a){var rgb=this.toHex(r,g,b,a);for(var alias in this.colors){if(this.colors[alias]===rgb){return alias;}}
return false;},RGBtoHSB:function(r,g,b,a){r/=255;g/=255;b/=255;var H,S,V,C;V=Math.max(r,g,b);C=V-Math.min(r,g,b);H=(C===0?null:V===r?(g-b)/C:V===g?(b-r)/C+2:(r-g)/C+4);H=((H+360)%6)*60/360;S=C===0?0:C/V;return{h:this._sanitizeNumber(H),s:S,b:V,a:this._sanitizeNumber(a)};},HueToRGB:function(p,q,h){if(h<0){h+=1;}else if(h>1){h-=1;}
if((h*6)<1){return p+(q-p)*h*6;}else if((h*2)<1){return q;}else if((h*3)<2){return p+(q-p)*((2/3)-h)*6;}else{return p;}},HSLtoRGB:function(h,s,l,a){if(s<0){s=0;}
var q;if(l<=0.5){q=l*(1+s);}else{q=l+s-(l*s);}
var p=2*l-q;var tr=h+(1/3);var tg=h;var tb=h-(1/3);var r=Math.round(this.HueToRGB(p,q,tr)*255);var g=Math.round(this.HueToRGB(p,q,tg)*255);var b=Math.round(this.HueToRGB(p,q,tb)*255);return[r,g,b,this._sanitizeNumber(a)];},toString:function(format){format=format||'rgba';var c=false;switch(format){case'rgb':{c=this.toRGB();if(this.rgbaIsTransparent(c)){return'transparent';}
return'rgb('+c.r+','+c.g+','+c.b+')';}
break;case'rgba':{c=this.toRGB();return'rgba('+c.r+','+c.g+','+c.b+','+c.a+')';}
break;case'hsl':{c=this.toHSL();return'hsl('+Math.round(c.h*360)+','+Math.round(c.s*100)+'%,'+Math.round(c.l*100)+'%)';}
break;case'hsla':{c=this.toHSL();return'hsla('+Math.round(c.h*360)+','+Math.round(c.s*100)+'%,'+Math.round(c.l*100)+'%,'+c.a+')';}
break;case'hex':{return this.toHex();}
break;case'alias':return this.toAlias()||this.toHex();default:{return c;}
break;}},stringParsers:[{re:/rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*?\)/,format:'rgb',parse:function(execResult){return[execResult[1],execResult[2],execResult[3],1];}},{re:/rgb\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*?\)/,format:'rgb',parse:function(execResult){return[2.55*execResult[1],2.55*execResult[2],2.55*execResult[3],1];}},{re:/rgba\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,format:'rgba',parse:function(execResult){return[execResult[1],execResult[2],execResult[3],execResult[4]];}},{re:/rgba\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,format:'rgba',parse:function(execResult){return[2.55*execResult[1],2.55*execResult[2],2.55*execResult[3],execResult[4]];}},{re:/hsl\(\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*?\)/,format:'hsl',parse:function(execResult){return[execResult[1]/360,execResult[2]/100,execResult[3]/100,execResult[4]];}},{re:/hsla\(\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,format:'hsla',parse:function(execResult){return[execResult[1]/360,execResult[2]/100,execResult[3]/100,execResult[4]];}},{re:/#?([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,format:'hex',parse:function(execResult){return[parseInt(execResult[1],16),parseInt(execResult[2],16),parseInt(execResult[3],16),1];}},{re:/#?([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/,format:'hex',parse:function(execResult){return[parseInt(execResult[1]+execResult[1],16),parseInt(execResult[2]+execResult[2],16),parseInt(execResult[3]+execResult[3],16),1];}}],colorNameToHex:function(name){if(typeof this.colors[name.toLowerCase()]!=='undefined'){return this.colors[name.toLowerCase()];}
return false;}};var defaults={horizontal:false,inline:false,color:false,format:false,input:'input',container:false,component:'.add-on, .input-group-addon',sliders:{saturation:{maxLeft:100,maxTop:100,callLeft:'setSaturation',callTop:'setBrightness'},hue:{maxLeft:0,maxTop:100,callLeft:false,callTop:'setHue'},alpha:{maxLeft:0,maxTop:100,callLeft:false,callTop:'setAlpha'}},slidersHorz:{saturation:{maxLeft:100,maxTop:100,callLeft:'setSaturation',callTop:'setBrightness'},hue:{maxLeft:100,maxTop:0,callLeft:'setHue',callTop:false},alpha:{maxLeft:100,maxTop:0,callLeft:'setAlpha',callTop:false}},template:'<div class="colorpicker dropdown-menu">'+'<div class="colorpicker-saturation"><i><b></b></i></div>'+'<div class="colorpicker-hue"><i></i></div>'+'<div class="colorpicker-alpha"><i></i></div>'+'<div class="colorpicker-color"><div /></div>'+'<div class="colorpicker-selectors"></div>'+'</div>',align:'right',customClass:null,colorSelectors:null};var Colorpicker=function(element,options){this.element=$(element).addClass('colorpicker-element');this.options=$.extend(true,{},defaults,this.element.data(),options);this.component=this.options.component;this.component=(this.component!==false)?this.element.find(this.component):false;if(this.component&&(this.component.length===0)){this.component=false;}
this.container=(this.options.container===true)?this.element:this.options.container;this.container=(this.container!==false)?$(this.container):false;this.input=this.element.is('input')?this.element:(this.options.input?this.element.find(this.options.input):false);if(this.input&&(this.input.length===0)){this.input=false;}
this.color=new Color(this.options.color!==false?this.options.color:this.getValue(),this.options.colorSelectors);this.format=this.options.format!==false?this.options.format:this.color.origFormat;this.picker=$(this.options.template);if(this.options.customClass){this.picker.addClass(this.options.customClass);}
if(this.options.inline){this.picker.addClass('colorpicker-inline colorpicker-visible');}else{this.picker.addClass('colorpicker-hidden');}
if(this.options.horizontal){this.picker.addClass('colorpicker-horizontal');}
if(this.format==='rgba'||this.format==='hsla'||this.options.format===false){this.picker.addClass('colorpicker-with-alpha');}
if(this.options.align==='right'){this.picker.addClass('colorpicker-right');}
if(this.options.colorSelectors){var colorpicker=this;$.each(this.options.colorSelectors,function(name,color){var $btn=$('<i />').css('background-color',color).data('class',name);$btn.click(function(){colorpicker.setValue($(this).css('background-color'));});colorpicker.picker.find('.colorpicker-selectors').append($btn);});this.picker.find('.colorpicker-selectors').show();}
this.picker.on('mousedown.colorpicker touchstart.colorpicker',$.proxy(this.mousedown,this));this.picker.appendTo(this.container?this.container:$('body'));if(this.input!==false){this.input.on({'keyup.colorpicker':$.proxy(this.keyup,this)});this.input.on({'change.colorpicker':$.proxy(this.change,this)});if(this.component===false){this.element.on({'focus.colorpicker':$.proxy(this.show,this)});}
if(this.options.inline===false){this.element.on({'focusout.colorpicker':$.proxy(this.hide,this)});}}
if(this.component!==false){this.component.on({'click.colorpicker':$.proxy(this.show,this)});}
if((this.input===false)&&(this.component===false)){this.element.on({'click.colorpicker':$.proxy(this.show,this)});}
if((this.input!==false)&&(this.component!==false)&&(this.input.attr('type')==='color')){this.input.on({'click.colorpicker':$.proxy(this.show,this),'focus.colorpicker':$.proxy(this.show,this)});}
this.update();$($.proxy(function(){this.element.trigger('create');},this));};Colorpicker.Color=Color;Colorpicker.prototype={constructor:Colorpicker,destroy:function(){this.picker.remove();this.element.removeData('colorpicker').off('.colorpicker');if(this.input!==false){this.input.off('.colorpicker');}
if(this.component!==false){this.component.off('.colorpicker');}
this.element.removeClass('colorpicker-element');this.element.trigger({type:'destroy'});},reposition:function(){if(this.options.inline!==false||this.options.container){return false;}
var type=this.container&&this.container[0]!==document.body?'position':'offset';var element=this.component||this.element;var offset=element[type]();if(this.options.align==='right'){offset.left-=this.picker.outerWidth()-element.outerWidth();}
this.picker.css({top:offset.top+element.outerHeight(),left:offset.left});},show:function(e){if(this.isDisabled()){return false;}
this.picker.addClass('colorpicker-visible').removeClass('colorpicker-hidden');this.reposition();$(window).on('resize.colorpicker',$.proxy(this.reposition,this));if(e&&(!this.hasInput()||this.input.attr('type')==='color')){if(e.stopPropagation&&e.preventDefault){e.stopPropagation();e.preventDefault();}}
if(this.options.inline===false){$(window.document).on({'mousedown.colorpicker':$.proxy(this.hide,this)});}
this.element.trigger({type:'showPicker',color:this.color});},hide:function(){this.picker.addClass('colorpicker-hidden').removeClass('colorpicker-visible');$(window).off('resize.colorpicker',this.reposition);$(document).off({'mousedown.colorpicker':this.hide});this.update();this.element.trigger({type:'hidePicker',color:this.color});},updateData:function(val){val=val||this.color.toString(this.format);this.element.data('color',val);return val;},updateInput:function(val){val=val||this.color.toString(this.format);if(this.input!==false){if(this.options.colorSelectors){var color=new Color(val,this.options.colorSelectors);var alias=color.toAlias();if(typeof this.options.colorSelectors[alias]!=='undefined'){val=alias;}}
this.input.prop('value',val);}
return val;},updatePicker:function(val){if(val!==undefined){this.color=new Color(val,this.options.colorSelectors);}
var sl=(this.options.horizontal===false)?this.options.sliders:this.options.slidersHorz;var icns=this.picker.find('i');if(icns.length===0){return;}
if(this.options.horizontal===false){sl=this.options.sliders;icns.eq(1).css('top',sl.hue.maxTop*(1-this.color.value.h)).end().eq(2).css('top',sl.alpha.maxTop*(1-this.color.value.a));}else{sl=this.options.slidersHorz;icns.eq(1).css('left',sl.hue.maxLeft*(1-this.color.value.h)).end().eq(2).css('left',sl.alpha.maxLeft*(1-this.color.value.a));}
icns.eq(0).css({'top':sl.saturation.maxTop-this.color.value.b*sl.saturation.maxTop,'left':this.color.value.s*sl.saturation.maxLeft});this.picker.find('.colorpicker-saturation').css('backgroundColor',this.color.toHex(this.color.value.h,1,1,1));this.picker.find('.colorpicker-alpha').css('backgroundColor',this.color.toHex());this.picker.find('.colorpicker-color, .colorpicker-color div').css('backgroundColor',this.color.toString(this.format));return val;},updateComponent:function(val){val=val||this.color.toString(this.format);if(this.component!==false){var icn=this.component.find('i').eq(0);if(icn.length>0){icn.css({'backgroundColor':val});}else{this.component.css({'backgroundColor':val});}}
return val;},update:function(force){var val;if((this.getValue(false)!==false)||(force===true)){val=this.updateComponent();this.updateInput(val);this.updateData(val);this.updatePicker();}
return val;},setValue:function(val){this.color=new Color(val,this.options.colorSelectors);this.update(true);this.element.trigger({type:'changeColor',color:this.color,value:val});},getValue:function(defaultValue){defaultValue=(defaultValue===undefined)?'#000000':defaultValue;var val;if(this.hasInput()){val=this.input.val();}else{val=this.element.data('color');}
if((val===undefined)||(val==='')||(val===null)){val=defaultValue;}
return val;},hasInput:function(){return(this.input!==false);},isDisabled:function(){if(this.hasInput()){return(this.input.prop('disabled')===true);}
return false;},disable:function(){if(this.hasInput()){this.input.prop('disabled',true);this.element.trigger({type:'disable',color:this.color,value:this.getValue()});return true;}
return false;},enable:function(){if(this.hasInput()){this.input.prop('disabled',false);this.element.trigger({type:'enable',color:this.color,value:this.getValue()});return true;}
return false;},currentSlider:null,mousePointer:{left:0,top:0},mousedown:function(e){if(!e.pageX&&!e.pageY&&e.originalEvent){e.pageX=e.originalEvent.touches[0].pageX;e.pageY=e.originalEvent.touches[0].pageY;}
e.stopPropagation();e.preventDefault();var target=$(e.target);var zone=target.closest('div');var sl=this.options.horizontal?this.options.slidersHorz:this.options.sliders;if(!zone.is('.colorpicker')){if(zone.is('.colorpicker-saturation')){this.currentSlider=$.extend({},sl.saturation);}else if(zone.is('.colorpicker-hue')){this.currentSlider=$.extend({},sl.hue);}else if(zone.is('.colorpicker-alpha')){this.currentSlider=$.extend({},sl.alpha);}else{return false;}
var offset=zone.offset();this.currentSlider.guide=zone.find('i')[0].style;this.currentSlider.left=e.pageX-offset.left;this.currentSlider.top=e.pageY-offset.top;this.mousePointer={left:e.pageX,top:e.pageY};$(document).on({'mousemove.colorpicker':$.proxy(this.mousemove,this),'touchmove.colorpicker':$.proxy(this.mousemove,this),'mouseup.colorpicker':$.proxy(this.mouseup,this),'touchend.colorpicker':$.proxy(this.mouseup,this)}).trigger('mousemove');}
return false;},mousemove:function(e){if(!e.pageX&&!e.pageY&&e.originalEvent){e.pageX=e.originalEvent.touches[0].pageX;e.pageY=e.originalEvent.touches[0].pageY;}
e.stopPropagation();e.preventDefault();var left=Math.max(0,Math.min(this.currentSlider.maxLeft,this.currentSlider.left+((e.pageX||this.mousePointer.left)-this.mousePointer.left)));var top=Math.max(0,Math.min(this.currentSlider.maxTop,this.currentSlider.top+((e.pageY||this.mousePointer.top)-this.mousePointer.top)));this.currentSlider.guide.left=left+'px';this.currentSlider.guide.top=top+'px';if(this.currentSlider.callLeft){this.color[this.currentSlider.callLeft].call(this.color,left/this.currentSlider.maxLeft);}
if(this.currentSlider.callTop){this.color[this.currentSlider.callTop].call(this.color,top/this.currentSlider.maxTop);}
if(this.currentSlider.callTop==='setAlpha'&&this.options.format===false){if(this.color.value.a!==1){this.format='rgba';this.color.origFormat='rgba';}
else{this.format='hex';this.color.origFormat='hex';}}
this.update(true);this.element.trigger({type:'changeColor',color:this.color});return false;},mouseup:function(e){e.stopPropagation();e.preventDefault();$(document).off({'mousemove.colorpicker':this.mousemove,'touchmove.colorpicker':this.mousemove,'mouseup.colorpicker':this.mouseup,'touchend.colorpicker':this.mouseup});return false;},change:function(e){this.keyup(e);},keyup:function(e){if((e.keyCode===38)){if(this.color.value.a<1){this.color.value.a=Math.round((this.color.value.a+0.01)*100)/100;}
this.update(true);}else if((e.keyCode===40)){if(this.color.value.a>0){this.color.value.a=Math.round((this.color.value.a-0.01)*100)/100;}
this.update(true);}else{this.color=new Color(this.input.val(),this.options.colorSelectors);if(this.color.origFormat&&this.options.format===false){this.format=this.color.origFormat;}
if(this.getValue(false)!==false){this.updateData();this.updateComponent();this.updatePicker();}}
this.element.trigger({type:'changeColor',color:this.color,value:this.input.val()});}};$.colorpicker=Colorpicker;$.fn.colorpicker=function(option){var pickerArgs=arguments,rv;var $returnValue=this.each(function(){var $this=$(this),inst=$this.data('colorpicker'),options=((typeof option==='object')?option:{});if((!inst)&&(typeof option!=='string')){$this.data('colorpicker',new Colorpicker(this,options));}else{if(typeof option==='string'){rv=inst[option].apply(inst,Array.prototype.slice.call(pickerArgs,1));}}});if(option==='getValue'){return rv;}
return $returnValue;};$.fn.colorpicker.constructor=Colorpicker;}));;(function(global,$){$.extend($.expr[':'],{'impressor':function(a,i,m){var top=$(window).scrollTop(),fold=$(window).height()+top;return(!(fold-75<=$(a).offset().top)&&!(top+150>=$(a).offset().top+$(a).height()));}});var Impressor={};Impressor.VERSION='1.0.1';Impressor.TOPIC='impressor';Impressor.LOGGER=log.getLogger('impressor');navigator.sendBeacon=(navigator.sendBeacon||function(url,data){$.ajax({'contentType':'text/plain;charset=UTF-8','async':false,'type':'POST','data':data,'url':url});});var Collector=function(){this.parse=_.throttle(_.bind(this._parse,this),350);this.logger=Impressor.LOGGER;};Collector.prototype={'data':null,'time_out':0,'options':null,'defaults':{'impress_key':'im','data_key':'id','selector':'','data':{}},'setup':function(options){this.options=_.extend({},this.defaults,options||{});PubSub.subscribe(Impressor.TOPIC,_.bind(this.add,this));$(window).on('unload',_.bind(this.store,this));$(window).on('resize scroll',this.parse);this.logger.info('SETUP:',this.options);this.update();},'add':function(msg,data){if(_.has(data,'tag')&&_.has(data,'id')){if(!_.isArray(this.data[data.tag])){this.data[data.tag]=[];}
if(!_.contains(this.data[data.tag],data.id)){this.logger.debug('ADD:',data,this.data[data.tag].length);this.data[data.tag].push(data.id);}}},'push':function(tag,id){PubSub.publish(Impressor.TOPIC,{'tag':tag,'id':id});},'_parse':function(){this.logger.info('PARSING DOCUMENT');var items=$(document).find(this.options.selector+'[data-'+this.options.data_key+']:impressor');_.each(items,function(item){this.push(this.options.impress_key,$(item).data(this.options.data_key));},this);},'update':function(data){var old_data=_.pick(this.data,_.keys(this.options.data)),new_data=_.extend({},this.options.data,data||{});if(!_.isEqual(old_data,new_data)){this.store();this.data=new_data;}},'store':function(event){if(!_.isEmpty(this.data)){this.logger.info('STORE DATA');var url=this.options.url+'?_ts='+_.now(),data=JSON.stringify(this.data);navigator.sendBeacon(url,data);}}};var collector=new Collector();Impressor.update=_.bind(collector.update,collector);Impressor.setup=_.bind(collector.setup,collector);Impressor.parse=_.bind(collector.parse,collector);Impressor.push=_.bind(collector.push,collector);global.Impressor=Impressor;}(this,jQuery));;(function(global,$){var Zoom={};Zoom.VERSION='2.0.0';Zoom.LOGGER=log.getLogger('zoom');Zoom.Scales=function(options){this.initialize.apply(this,arguments);this.idx=0;};Zoom.Scales.prototype=Array.prototype;_.extend(Zoom.Scales.prototype,Backbone.Events,{initialize:function(options){this.listenTo(options.view,'reset',this.reset);var prev_scale=1,long_side=Math.max(options.width,options.height);_.each(options.sizes,function(size){var scale=(size.size/long_side);this.push({adjust:(scale/prev_scale),display:size.name,scale:scale});prev_scale=scale;},this);},current:function(){return this[this.idx-1];},next:function(){return this[this.idx];},params:function(){return{scale:this.next().scale};},increment:function(){this.idx++;},reset:function(){this.idx=0;},hasNext:function(){return(this.idx<this.length);}});Zoom.Box=Backbone.View.extend({tagName:'div',className:'zoom-box',offset:{left:0,top:0},initialize:function(options){this.view=options.view;this.view.$el.on('mousemove',_.throttle(_.bind(this.mousemove,this),25));this.view.$el.on('mouseenter',_.bind(this.mouseenter,this));this.view.$el.on('mouseleave',_.bind(this.mouseleave,this));this.listenTo(this.view,'reset',this.reset,this);this.listenTo(this.view,'loading',this.loading,this);this.listenTo(this.view,'load',this.load,this);this.offset.left=this.offset.top=0;this.setup();},setup:function(){var scale=this.view.scales.next();this.$el.width(Math.floor(this.view.width/scale.adjust));this.$el.height(Math.floor(this.view.height/scale.adjust));this.data={max_left:(this.view.width-this.$el.outerWidth()),max_top:(this.view.height-this.$el.outerHeight()),center_left:(this.$el.width()/2),center_top:(this.$el.height()/2)};if(this.view.$el.is(':hover'))this.mouseenter();},mousemove:function(event){var offset=this.view.$el.offset();var mouseLeft=Math.floor(event.clientX-offset.left+$(document).scrollLeft()),mouseTop=Math.floor(event.clientY-offset.top+$(document).scrollTop());this.$el.css({left:Math.max(Math.min((mouseLeft-this.data.center_left),this.data.max_left),0),top:Math.max(Math.min((mouseTop-this.data.center_top),this.data.max_top),0)});},mouseenter:function(event){if(this.view.scales.hasNext()){this.$el.show();}},mouseleave:function(event){this.$el.hide();},params:function(){return{left:this.offset.left,top:this.offset.top};},loading:function(event){var position=this.$el.position();var scale=this.view.scales.next();this.offset.left=parseInt((this.offset.left+position.left)*scale.adjust);this.offset.top=parseInt((this.offset.top+position.top)*scale.adjust);this.$el.hide();},load:function(event){if(this.view.scales.hasNext()){if(this.view.$el.is(':hover'))this.$el.show();this.setup();}},reset:function(event){this.offset.left=this.offset.top=0;this.setup();}});Zoom.Details=Backbone.View.extend({tagName:'div',className:'zoom-details',initialize:function(options){this.view=options.view;this.listenTo(this.view,'reset',this.reset);this.listenTo(this.view,'load',this.load);},reset:function(){this.$el.hide();},load:function(){var scale=this.view.scales.current();this.$el.html(scale.display).show();}});Zoom.Loading=Backbone.View.extend({tagName:'div',className:'zoom-loading',initialize:function(options){this.view=options.view;this.listenTo(this.view,'load reset',this.load);this.listenTo(this.view,'loading',this.loading);},loading:function(event){this.$el.show();},load:function(){this.$el.hide();}});Zoom.Image=Backbone.View.extend({tagName:'img',className:'zoom-img',events:{'error':'error','load':'load'},initialize:function(options){this.view=options.view;this.listenTo(this.view,'reset',this.reset);},reset:function(event){this.$el.hide();},error:function(event){this.trigger('error');},load:function(event){this.view.trigger('load');this.$el.show();}});Zoom.View=Backbone.View.extend({defaults:{message:'Zoom Error',url:'/zoom/'},events:{'mouseup':'mouseup'},initialize:function(options){_.bindAll(this,'setup','reset');_.defaults(this,options,this.defaults);$(document).on('mouseup',this.reset);this.$('img').each(_.bind(function(idx,el){if(el.complete)this.setup();},this)).on('load',this.setup);},setup:function(){this.width=this.$el.width();this.height=this.$el.height();Zoom.LOGGER.info('Zoom Width:'+this.width+' Zoom Height:'+this.height);this.scales=new Zoom.Scales({height:this.height,width:this.width,sizes:this.sizes,view:this});this.box_view=new Zoom.Box({view:this});this.$el.append(this.box_view.$el);this.image_view=new Zoom.Image({view:this});this.$el.append(this.image_view.$el);this.details_view=new Zoom.Details({view:this});this.$el.append(this.details_view.$el);this.loading_view=new Zoom.Loading({view:this});this.$el.append(this.loading_view.$el);this.listenTo(this.image_view,'error',this.error);},mouseup:function(event){event.stopPropagation();if(this.scales.hasNext()){this.zoom(event);}else{this.reset(event);}},params:function(){return _.extend({height:this.height,width:this.width,id:this.id,_ts:_.now()},this.scales.params(),this.box_view.params());},zoom:function(event){this.trigger('loading');var params=this.params();Zoom.LOGGER.info('Zoom Params:',params);this.image_view.$el.attr('src',this.url+'?'+$.param(params));this.scales.increment();},reset:function(event){this.trigger('reset');},error:function(){Zoom.LOGGER.info('Zoom Error:',arguments);this.reset();this.details_view.remove();this.loading_view.remove();this.image_view.remove();this.box_view.remove();this.undelegateEvents();this.$el.append('<div class="zoom-message">'+'<div class="zoom-error">'+'<p>'+this.message+'</p>'+'</div>'+'</div>');$(document).on('mouseup',_.bind(function(){this.$('div.zoom-message').remove();},this));}});global.Zoom=Zoom;$.fn.zoom=function(options){return this.each(function(){if(!$(this).data('zoom')){$(this).data('zoom',new Zoom.View(_.extend({el:$(this)},options)));}});};}(this,jQuery));;(function($,undefined){var Detailed=Backbone.View.extend({events:{'click span.contributor em':'contributor','grid:resize':'resize'},initialize:function(){var resize=_.throttle(_.bind(this.resize,this),250);$(window).on('resize load',resize);$(document).on('ready',resize);},resize:function(){if(this.$el.data('mode')=='det'){this.$('img[data-ratio]').bannerhide({mask:'span.thumb-mask',maxWidth:150,height:150});var columns=Math.floor(this.$el.width()/170),cells=this.$('img[data-ratio]').length,remaining=(columns-(cells%columns)),width=(remaining*170)-(2+10+20+70);if(remaining!=columns){this.$('li.next-results').css({paddingTop:58,width:'auto'}).removeClass('hide');this.$('div.next-results-arrow').css({textIndent:(width<110)?'-9999px':'0px',width:width});}else{this.$('li.next-results').addClass('hide');}}},contributor:function(event){var url=jslink({viewname:'profile',kwargs:{username:$(event.currentTarget).text()}});window.open(url,'_self');}});$.fn.detailed=function(options){return this.each(function(){if(!$(this).data('detailed')){var view=new Detailed({el:$(this)});$(this).data('detailed',view);}});};})(jQuery);;(function($,undefined){var GridNext=function($container){this.$el=$container.find('li.next-results');this.$arrow=this.$el.find('div.next-results-arrow');};GridNext.prototype={update:function(row){var arrow_space=(2+10+20+70);if(row.remaining>=arrow_space){var padding=((row.height-98)/2),width=(row.remaining-arrow_space);this.$el.css({paddingBottom:padding,paddingTop:padding}).removeClass('hide');this.$arrow.css({textIndent:(width<110)?'-9999px':'0px',width:width});}else{this.$el.addClass('hide');}}};var GridCell=function($el,ratio,options){this.options=options;this.ratio=ratio;this.$el=$el;};GridCell.prototype={process:function(rheight){var ratio=parseFloat(this.ratio),width=Math.min(parseInt(rheight*ratio),350);var $container=this.$el.parent();$container.parent().css('height',rheight);$container.find(this.options.mask).css({height:rheight,width:width});$container.css({height:rheight,width:width,marginTop:0});if((Math.round(ratio*100)/100)<1){this.$el.css({height:rheight,width:'auto'});}else{var r_ratio=parseFloat(this.$el.data('ratio'));if((width/r_ratio)<rheight){var sheight=parseInt(width/r_ratio);$container.css({marginTop:parseInt((rheight-sheight)/2),height:sheight});}
this.$el.css({height:'auto',width:width});}
return width;}};var GridRow=function(options){this.options=options;this.cells=[];this.padding=0;this.height=0;this.width=0;};GridRow.prototype={max:200,add:function($elem){var ratio=parseFloat($elem.data('ratio'));var width=Math.min(Math.floor(ratio*this.max),350);this.cells.push(new GridCell($elem,(width/this.max),this.options));this.padding+=(2+10);this.width+=width;},process:function(cwidth){this.remaining=(cwidth-this.padding);if(this.cells.length==1){this.cells[0].ratio=this.cells[0].$el.data('ratio');this.height=Math.min((this.remaining/this.cells[0].ratio),this.max);}else{this.height=Math.min(Math.floor(this.max*this.remaining/this.width),this.max);}
_.each(this.cells,function(cell){this.remaining-=cell.process(this.height);},this);}};var Grid=function(element,options){var resize=_.throttle(_.bind(this.resize,this),500);this.options=_.extend({},this.defaults,options);this.$el=$(element);$(window).on('resize load',resize);$(document).on('ready',resize);this.$el.on('grid:resize',resize);this.scroll_width=this.get_scroll_width();this.grid_next=new GridNext(this.$el);};Grid.prototype={defaults:{mask:'span.thumb-mask',selector:'img'},get_scroll_width:function(){var $outer=$('<div>').css({visibility:'hidden',overflow:'scroll',width:'100px'}).appendTo('body'),scroll_width=$('<div>').css({width:'100%'}).appendTo($outer).outerWidth();$outer.remove();return(100-scroll_width);},subtract:function(){return($(document).height()<=$(window).height())?this.scroll_width:0;},resize:function(){if(this.$el.data('mode')=='grd'){var cwidth=(this.$el.width()-this.subtract()),row=new GridRow(this.options),rows=[];if(cwidth<=10){_.delay(_.bind(this.resize,this),500);return;}
_.each(this.$el.find(this.options.selector),function(elem){row.add($(elem));if(row.width>=(cwidth-row.padding)){rows.push(row);row=new GridRow(this.options);}},this);if(row.cells.length>0)rows.push(row);_.each(rows,function(row){row.process(cwidth);});this.grid_next.update(row);this.$el.trigger('grid:resized');}}};$.fn.grid=function(option){return this.each(function(){var options=typeof option=='object'&&option,grid=$.data(this,'grid');if(!grid)$.data(this,'grid',(grid=new Grid(this,options||{})));if(typeof option=='string')grid[option]();});};})(jQuery);;(function(csp,$,undefined){csp.SearchRouter=Backbone.Router.extend({initialize:function(options){this.route(new RegExp('^(.+)$'),'search');Backbone.history.start({hashChange:false,pushState:true,silent:true});}});})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,undefined){csp.SearchJumpView=Backbone.View.extend({events:{'click':'click'},initialize:function(options){$(window).on('scroll',_.debounce(_.bind(this.scroll,this),200));},scroll:function(event){if($(window).scrollTop()>320&&!$('body,html').is(':animated')){this.$el.slideDown(200);}else{this.$el.slideUp(200);}},click:function(event){event.preventDefault();$('body,html').animate({scrollTop:0},300);this.$el.hide();}});})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,undefined){csp.SearchParams=Backbone.Model.extend({top:0,defaults:{search_phrase:'',search_type:'ALL',search_page:1,search_exact:'',search_orientation:[],search_releases:[],search_exclude:'',search_artist:'',search_color:null,content_filter:null},tag_filters:['search_exact','search_orientation','search_exclude','search_artist','search_releases','search_color'],toDATA:function(){var data={};_.each(this.toJSON(),function(value,key){if(!_.isEqual(this.defaults[key],value)){data[key]=value;}},this);return data;},reset:function(key,options){this.set(key,this.defaults[key],options);},resetAll:function(options){this.set(_.pick(this.defaults,this.tag_filters),options);},tags:function(iteratee,context){_.each(this.pick(this.tag_filters),function(value,key){if(!_.isEqual(this.defaults[key],value)){_.bind(iteratee,context)(value,key);}},this);},set:function(key,val,options){var attrs;if(typeof key==='object'){options=val;attrs=key;}else{(attrs={})[key]=val;}
_.defaults(attrs,{search_page:1});options=options||{};_.defaults(options,{loading:false});Backbone.Model.prototype.set.call(this,attrs,options);}});})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,undefined){csp.SearchHeaderView=Backbone.View.extend({initialize:function(options){_.bindAll(this,'submit','change','load');this.$('input[name="search_phrase"]').on('keyup',_.debounce(this.change,750));this.$('input[name="search_phrase"]').on('change:suggest paste',this.change);this.$('input[name="search_type"]').on('change',this.change);this.listenTo(this.model,'search:load',this.load);this.$el.on('submit',this.submit);},load:function(model,value,option){if(!this.$('input[name="search_phrase"]').is(':focus')){this.$('input[name="search_phrase"]').val(this.model.get('search_phrase'));}},submit:function(event){event.preventDefault();this.change();return false;},change:function(event){this.model.set(_.extend({search_page:1},this.$el.serializeObject()));}});})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp){var Filter=Backbone.View.extend({tagName:'form',className:'form-group col-xs-6 col-sm-4 col-md-3',initialize:function(options){_.extend(this,options);this.listenTo(this.model,'change:'+this.name,_.bind(this.render,this));this.$el.on('submit',_.bind(this.submit,this));},submit:function(event){event.preventDefault();this.change();return false;},change:function(){var data=this.$el.serializeObject();this.model.set(this.parse(data));},value:function(){return this.model.get(this.name);},parse:function(value){return value;},render:function(){this.$el.html(this.template(this));return this;}});var ButtonGroupFilter=Filter.extend({template:_.template('<label><%= label %></label>'+'<div class="input-group">'+'<div class="btn-group btn-group-sm" data-toggle="buttons">'+'<% _.each(buttons, function (button) { %>'+'<label class="btn btn-default<% if (selected(button.value)) { %> active<% } %>" title="<%= button.title %>">'+'<input type="radio" name="<%= name %>" value="<%= button.value %>"<% if (selected(button.value)) { %> checked="checked"<% } %> />'+'<span><%= button.text %></span>'+'</label>'+'<% }); %>'+'</div>'+'</div>'),events:{'change input':'change'},selected:function(value){return _.isEqual(this.value(),value);}});var InputFilter=Filter.extend({template:_.template('<label><%= label %></label>'+'<input name="<%= name %>" value="<%= value() %>" type="text" class="form-control" placeholder="<%= placeholder %>" title="<%= title %>" />'),initialize:function(options){Filter.prototype.initialize.call(this,options);this.delegate('change keyup paste','input',_.debounce(_.bind(this.change,this),750));},render:function(){if(!this.$('input').is(':focus')){this.$el.html(this.template(this));}
return this;}});var ArtistFilter=InputFilter.extend({className:'form-group search-artist col-xs-6 col-sm-4 col-md-3',initialize:function(options){Filter.prototype.initialize.call(this,options);this.delegate('change:suggest','input',_.debounce(_.bind(this.change,this),750));},render:function(){if(!this.$('input').is(':focus')){this.$el.html(this.template(this));this.$('input').suggest({url:'/suggest/artist/'});}
return this;}});var ColorFilter=InputFilter.extend({className:'form-group search-color col-xs-6 col-sm-4 col-md-3',template:_.template('<label><%= label %></label>'+'<div class="input-group">'+'<input name="<%= name %>" value="<%= value() %>" type="text" class="form-control" placeholder="<%= placeholder %>" maxlength="7" />'+'<span class="input-group-addon">'+'<span class="cspicon icon-eyedropper"></span>'+'</span>'+'</div>'),initialize:function(options){InputFilter.prototype.initialize.call(this,options);this.delegate('changeColor','input',_.debounce(_.bind(this.change,this),750));},render:function(){if(!this.$('input').is(':focus')){this.$el.html(this.template(this));this.$('input').colorpicker({customClass:'colorpicker-2x',format:'hex',align:'left',sliders:{saturation:{maxLeft:200,maxTop:200},hue:{maxTop:200},alpha:{maxTop:200}}});}
return this;}});csp.search_filters=function(model){return[new ButtonGroupFilter({model:model,name:'search_exact',label:gettext('Search Type'),buttons:[{title:gettext('Contains the keywords entered, in any order (more broad)'),text:gettext('Containing Words'),value:''},{title:gettext('Must match the exact search phrase entered (more specific)'),text:gettext('Exact Phrase'),value:'1'}]}),new ButtonGroupFilter({model:model,name:'content_filter',label:gettext('Content Filter'),parse:function(value){value[this.name]=parseInt(value[this.name]);this.model.trigger('reset:cache');return value;},buttons:[{title:gettext('Show all results'),text:gettext('Off'),value:0},{title:gettext('Block nude content'),text:gettext('Moderate'),value:1},{title:gettext('Block all potentially offensive content'),text:gettext('Strict'),value:2}]}),new ButtonGroupFilter({template:_.template('<label><%= label %></label>'+'<div class="input-group">'+'<div class="btn-group btn-group-sm orientations" data-toggle="buttons">'+'<% _.each(buttons, function (button) { %>'+'<label class="btn btn-default<% if (selected(button.value)) { %> active<% } %>" title="<%= button.text %>">'+'<input type="checkbox" name="<%= name %>" value="<%= button.value %>"<% if (selected(button.value)) { %> checked="checked"<% } %> />'+'<span class="orient-<%= button.value.toLowerCase() %>"></span>'+'<span class="sr-only"><%= button.text %></span>'+'</label>'+'<% }); %>'+'</div>'+'</div>'),model:model,name:'search_orientation',label:gettext('Specific Orientations'),parse:function(value){if(_.isUndefined(value[this.name]))value[this.name]=[];if(!_.isArray(value[this.name]))value[this.name]=[value[this.name]];return value;},selected:function(value){return _.contains(this.value(),value);},buttons:[{text:gettext('Vertical'),value:'V'},{text:gettext('Square'),value:'S'},{text:gettext('Horizontal'),value:'H'},{text:gettext('Panorama'),value:'P'}]}),new InputFilter({model:model,name:'search_exclude',label:gettext('Exclude From Results'),placeholder:gettext('Keywords'),title:gettext('Enter any keywords you would like to exclude.')}),new ArtistFilter({model:model,name:'search_artist',label:gettext('Search By Contributor'),placeholder:gettext('User Name'),title:gettext('Enter Contributor\'s User Name')}),new ColorFilter({model:model,name:'search_color',label:gettext('Primary Color'),placeholder:gettext('Hex Code')})]};})(window.canstockphoto=window.canstockphoto||{});;(function(csp,$){var RefineTag=function(data){this.data=data};_.extend(RefineTag.prototype,{text:function(key,value){var data=this.data[key];return _.isFunction(data)?data(value):data;}});var refine=new RefineTag({search_exact:gettext('Exact Phrase'),search_orientation:function(value){var $span=$('<span/>').addClass('orientations');_.each(value,function(key){$span.append($('<span />').addClass('orient-'+key.toLowerCase()));});return interpolate(gettext('Orientation: %(orientations)s'),{orientations:$span.wrap('<div/>').parent().html()},true);},search_exclude:function(value){return interpolate(gettext('Exclude: %(phrase)s'),{phrase:value},true);},search_artist:function(value){return interpolate(gettext('Artist: %(username)s'),{username:value},true);},search_releases:function(value){var text=ngettext('Model: %(release_id)s','Models: %(release_id)s',value.length);return interpolate(text,{release_id:value.join(', ')},true);},search_color:function(value){return interpolate(gettext('Color: %(color)s'),{color:'<span class="color" style="background-color: '+value+';"></span>'},true);}});var Tag=Backbone.View.extend({tagName:'span',className:'label label-info',events:{'click span.icon-times':'close'},template:_.template('<%= text %> <span class="cspicon icon-times cspicon-lg"></span>'),initialize:function(options){this.$el.addClass('refine-'+options.key);this.text=options.text;this.key=options.key;},close:function(){this.trigger('remove',this.key);this.remove();},render:function(){this.$el.html(this.template({text:this.text}));return this;}});csp.search_tags=function(key,value){var text=refine.text(key,value);return new Tag({text:text,key:key});};})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,undefined){csp.SearchRefineTagsView=Backbone.View.extend({events:{'click span.refine-clear':'removeAll'},initialize:function(options){this.listenTo(this.model,'change',_.bind(this.render,this));this.render();},removeTag:function(key){this.model.reset(key);},removeAll:function(){this.model.resetAll();},render:function(){this.$el.empty();this.model.tags(function(value,key){var tag=csp.search_tags(key,value);this.listenTo(tag,'remove',_.bind(this.removeTag,this));this.$el.append(tag.render().$el);},this);if(this.$el.children().length>1){this.$el.append('<span class="label label-danger refine-clear" title="'+gettext('Reset all filters')+'">'+'<span class="cspicon icon-undo cspicon-lg"></span>'+'</span>');}}});csp.SearchRefineView=Backbone.View.extend({initialize:function(options){this.listenTo(this.model,'refine:toggle',_.bind(this.toggle,this));this.$el.toggle(csp.search_data.get('refine-open'));this.fitlers=csp.search_filters(this.model);this.render();},toggle:function(event){csp.search_data.set({'refine-open':!csp.search_data.get('refine-open'),'refine-hint':false});$(window).scrollTop(0);this.$el.toggle(200);},render:function(){var $row=this.$('div.row');_.each(this.fitlers,function(filter){$row.append(filter.render().el);});}});})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,undefined){csp.SearchPaging=Backbone.Model.extend({page:function(dir){var url=this.get(dir);if(url){this.trigger('paging:search',this.decode(url));}},get_next:function(){var next=this.get('next');return(next)?this.decode(next):null;},decode:function(url){return Base64Decode(url);}});csp.SearchNavbarView=Backbone.View.extend({events:{'switchChange.bootstrapSwitch form.display-form input':'change','change form.display-form select':'change','click div.refine-form span.btn':'toggle','click div.paging-form button':'page'},initialize:function(options){this.paging=options.paging;this.$('input[name="display_preview"]').bootstrapSwitch();this.$('input[name="search_page"]').on('keyup',_.debounce(_.bind(this.keyup,this),500));this.listenTo(this.model,'results:load',_.bind(this.load,this));$(document).on('click','li.next-results',_.bind(this.page,this));$(document).on('keyup',_.bind(this.arrow,this));if(csp.search_data.get('refine-hint')){this.listenTo(this.model,'results:load',_.bind(this.load_hint,this));$('div.refine-form:first span.btn').tooltip({title:gettext("That's a lot of results")+' &nbsp;'+gettext('Narrow them down here'),container:'div.refine-form:first span.btn',placement:'right',trigger:'manual',html:true});if($('div.refine-form:first span.btn').hasClass('show-tooltip')){this.hint();}
csp.search_data.on('change:refine-hint',function(){$('div.refine-form:first span.btn').tooltip('destroy');});}},toggle:function(event){this.model.trigger('refine:toggle');},load:function(data){if($('li.next-results a').length>0){$('li.next-results').html($('li.next-results a').html());}
if(data.results.hits>10000){this.hint();}
this.$('button.btn-prev').toggleClass('hide',this.paging.get('prev')==null);this.$('button.btn-next').toggleClass('hide',this.paging.get('next')==null);},load_hint:function(data){if(data.results.hits>10000)this.hint();},show_hint_timeout:null,show_hint:function(){if($('div.refine-form:first span.btn div.tooltip.in').length==0){$('div.refine-form:first span.btn').tooltip('show');}
if(this.hide_hint_timeout)clearTimeout(this.hide_hint_timeout);this.hide_hint_timeout=_.delay(_.bind(this.hide_hint,this),15000);},hide_hint_timeout:null,hide_hint:function(){$('div.refine-form:first span.btn').tooltip('hide');},hint:function(){if(this.show_hint_timeout)clearTimeout(this.show_hint_timeout);this.show_hint_timeout=_.delay(_.bind(this.show_hint,this),1000);},page:function(event){var direction=$(event.currentTarget).data('page');this.paging.page(direction);event.preventDefault();return false;},arrow:function(event){if(!$(event.target).is('input')){var page={37:'prev',39:'next'}[event.which];if(page)this.paging.page(page);}},keyup:function(event){var search_page=parseInt(this.$(event.currentTarget).val());search_page=_.isNaN(search_page)?1:search_page;this.model.set('search_page',search_page);event.preventDefault();return false;},change:function(event){var data=this.$(event.currentTarget).closest('form.display-form').serializeObject();data.display_preview=(data.display_preview=='on');data.display_sort=parseInt(data.display_sort);data.display_rows=parseInt(data.display_rows);csp.preferences.set(data);}});})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,undefined){csp.DetailView=Backbone.View.extend({events:{'click span.btn-back-to-results':'back','click ul.list-keywords a':'search'},initialize:function(options){this.listenTo(this.model,'load:results',function(){this.$el.addClass('loading');});},search:function(event){var url=this.$(event.currentTarget).attr('href');this.trigger('search',url);this.model.top=0;return false;},back:function(event){window.history.back();},hide:function(){var detail_view=this.$('div.image-detail').data('detail');if(!_.isUndefined(detail_view))detail_view.remove();this.$('div.detail-results').empty();this.$el.hide();},load:function(data){this.model.set('search_page',0,{silent:true});this.model.trigger('detail:load',data);this.$el.removeClass('loading').show();this.$('div.detail-results').html(data.body);document.title=data.title;$(window).scrollTop(0);this.$('div.image-detail').detail(data.detail,false);}});})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,undefined){csp.RelatedSearchesView=Backbone.View.extend({template:_.template('<li data-phrase="<%= phrase %>">'+'<span class="phrase"><%= phrase %></span>'+'<div class="images">'+'<% _.each(images, function (image) { %>'+'<span class="image">'+'<img<%= image.data %>>'+'</span>'+'<% }); %>'+'</div>'+'</li>'),events:{'click li[data-phrase]':'click'},initialize:function(options){this.slider=this.$el.slider({height:70}).data('slider');this.render();},click:function(event){var phrase=this.$(event.currentTarget).data('phrase');this.model.set('search_phrase',phrase);},load:function(searches){this.$('ul').empty();var results=document.createDocumentFragment();_.each(searches,function(row){results.appendChild($(this.template(row)).get(0));},this);this.$('ul').html(results);this.render();},render:function(){this.$el.toggle(!this.$('ul').is(':empty'));this.slider.update();if(LANG!="en"){$(".related-searches").hide();}}});})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$){csp.SearchResult=Backbone.View.extend({tagName:'li',template:_.template('<a href="<%= url %>" class="thumb-preview thumb-favorites">'+'<span class="thumb-container">'+'<span class="thumb-mask"></span>'+'<img <%= data %>/>'+'</span>'+'<span class="title"><%= title %></span>'+'</a>'+'<span class="contributor"><%= contributor %></span>'+'<span class="details">'+'<span class="downloads"><%= downloads %></span>'+'<span>/</span>'+'<span class="views"><%= views %></span>'+'</span>'),initialize:function(options){this.result=options.result;},render:function(){this.result.contributor=interpolate(gettext('by %(username)s'),{username:'<em>'+this.result.username+'</em>'},true);this.$el.html(this.template(this.result));return this;}});csp.SearchResultsView=Backbone.View.extend({is_ajax_results:false,events:{'click a':'click'},initialize:function(){this.listenTo(csp.preferences,'change:display_mode',this.change);this.listenTo(this.model,'load:results',this.loading);this.$next=this.$('ul.list-results li.next-results');this.$('ul.list-results').grid().detailed();},hide:function(){this.$el.hide();},loading:function(){this.$('ul.list-results').addClass('loading');},clear:function(){this.$next.detach();this.$('ul.list-results').empty();},change:function(model,value){this.$('ul.list-results').attr('data-mode',value);this.$('ul.list-results').data('mode',value);this.$('ul.list-results').trigger('grid:resize');},load:function(data){this.is_ajax_results=true;this.$('ul.list-results').removeClass('loading');this.model.trigger('results:load',data);this.$el.show();this.$('h1').html(data['metadata'].heading);document.title=data['metadata'].title;this.$('span.pages').html(format_number(data['metadata']['pages']));this.$('input[name="search_page"]').val(data.params.search_page);if(data.results['docs'].length>0){var results=document.createDocumentFragment();_.each(data.results['docs'],function(doc){var search_result=new csp.SearchResult({result:doc});results.appendChild(search_result.render().el);});if(data.paging.next){results.appendChild(this.$next.show().get(0));}
this.$('ul.list-results').html(results);this.$('ul.list-results').trigger('grid:resize');$(window).scrollTop(this.model.top);}else{this.$next.detach();this.$('ul.list-results').html('<li class="no-results">'+'<strong>'+gettext('No results found!')+'</strong>'+'<p>'+gettext('Please try another search')+'</p>'+'</li>');}
Backbone.trigger('results:loaded');},click:function(event){var url=this.$(event.currentTarget).attr('href');this.model.trigger('view:detail',url);return false;}});})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,undefined){csp.SearchCache=function(options){this.options=_.extend({},this.defaults,options);this.reset();};_.extend(csp.SearchCache.prototype,{defaults:{size:10},reset:function(){this._cache_keys=[];this._cache={};},has:function(key){return _.contains(this._cache_keys,key);},get:function(key){return(this.has(key))?this._cache[key]:null;},set:function(key,val){if(!this.has(key)){this._cache_keys.push(key);this._cache[key]=val;if(this._cache_keys.length>this.options.size){delete this._cache[this._cache_keys.shift()];}}}});})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,globals){csp.search_data=new CookieData('search',{defaults:{'refine-hint':true,'refine-open':false}});csp.Search=function(options){this.params=new csp.SearchParams(options.params);this.paging=new csp.SearchPaging(options.paging);this.header=new csp.SearchHeaderView({el:$('form.header-search'),model:this.params});this.refine_tags=new csp.SearchRefineTagsView({el:$('span#refine_tags'),model:this.params});this.refine=new csp.SearchRefineView({el:$('div#refine_form'),model:this.params});this.navbar=new csp.SearchNavbarView({el:$('div.search-results nav.navbar'),paging:this.paging,model:this.params});this.results=new csp.SearchResultsView({el:$('div.search-view'),model:this.params});this.detail=new csp.DetailView({el:$('div.detail-view'),model:this.params});this.jump=new csp.SearchJumpView({el:$('div#jump')});this.related=new csp.RelatedSearchesView({el:$('div.related-searches'),model:this.params});this.router=new csp.SearchRouter({model:this.params});this.listenTo(csp.preferences,'change:display_sort change:display_rows',this.resetSearch);this.listenTo(this.params,'reset:cache',this.resetCache);this.listenTo(this.paging,'paging:search',this.research);this.listenTo(this.params,'view:detail',this.viewDetail);this.listenTo(this.router,'route:search',this.research);this.listenTo(this.detail,'search',this.research);this.listenTo(this.params,'change',this.search);this.preload();Impressor.setup({url:'/impressor/',selector:'img',data:{sp:options.params.search_phrase,st:options.params.search_type}});$('ul.list-results').on('grid:resized',Impressor.parse);};_.extend(csp.Search.prototype,Backbone.Events,{cache:new csp.SearchCache(),url:'/search.php',resetCache:function(){this.cache.reset();},resetSearch:function(){this.resetCache();this.params.set('search_page',1,{silent:true});this.search(null,{});},search:function(model,options){if(!options.loading){var prefs=_.pick(csp.preferences.toJSON(),'display_sort','display_rows'),data=_.extend(prefs,this.params.toDATA());if(this.xhr)this.xhr.abort();this.params.trigger('load:results');this.fetch(this.url,data,_.bind(this.load,this));}},research:function(url){url='/'+url.replace(/(^\/)/g,'');if(this.cache.has(url)){this.load(this.cache.get(url));}else{this.params.trigger('load:results');this.fetch(url,{},_.bind(this.load,this));}},fetch:function(url,data,callback){this.xhr=$.ajax({traditional:true,success:callback,data:data,url:url});},preload:function(){var url=this.paging.get_next();if(url&&!this.cache.has(url)){this.fetch(url,{},_.bind(function(data){this.cache.set(data.url,data);_.each(data.results.docs,function(doc){$('<img'+doc.data+' />');});},this));}},load:function(data){this.cache.set(data.url,data);if(data.type=='SEARCH'){Impressor.update({sp:data.params.search_phrase,st:data.params.search_type});this.router.navigate(data.url);this.params.set(data.params,{loading:true});this.params.trigger('search:load');this.related.load(data.related);this.paging.set(data.paging);this.results.load(data);this.detail.hide();this.preload();this.params.top=0;ga('send','pageview',data.analytics_id);}else if(data.type=='DETAIL'){this.params.top=$(window).scrollTop();this.router.navigate(data.url);this.detail.load(data);this.results.hide();Impressor.push('v',data.detail.image_id);ga('send','pageview','Comp');}},viewDetail:function(url){if(this.cache.has(url)){this.load(this.cache.get(url));}else{this.params.trigger('load:results');this.fetch(url,{},_.bind(this.load,this));}}});globals.CspSearch=csp.Search;})(window.canstockphoto=window.canstockphoto||{},jQuery,this);;(function(csp,$,undefined){csp.DownloadRequestModel=Backbone.Model.extend({xhr:null,defaults:{extra_html:null,is_locked:false,is_ready:false,downloads:[],url:null},is_polling:false,initialize:function(attributes,options){this.on('sync',_.bind(this.polling,this));},start_polling:function(){this.is_polling=true;this.fetch();},stop_polling:function(){this.is_polling=false;if(this.xhr)this.xhr.abort();},polling:function(model,resp,options){if(!this.get('is_locked')&&!this.get('is_ready')&&this.is_polling){_.delay(_.bind(this.fetch,this),1000);}},sync:function(method,model,options){if(this.xhr)this.xhr.abort();_.defaults(options||(options={}),{contentType:'application/json; charset=UTF-8',method:'POST',headers:{'X-CSRFToken':Cookies.get('csrftoken')},data:JSON.stringify(model),url:jslink({'viewname':'download:api'})});this.xhr=$.ajax(options);return this.xhr;},footer_text:function(){var text=gettext('Your download should start automatically, if it does not please click %(link_start)shere%(link_end)s.');return interpolate(text,{link_start:'<a href="'+this.get('url')+'">',link_end:'</a>'},true);},support_text:function(){var text=gettext('Please contact %(link_start)ssupport%(link_end)s if this problem persists.');return interpolate(text,{link_start:'<a href="/support.php?md12=true">',link_end:'</a>'},true);}});csp.DownloadRequestView=Backbone.View.extend({tagName:'div',className:'download-modal modal fade',events:{'hidden.bs.modal':'hide'},template:_.template('<div class="modal-dialog">'+'<div class="modal-content">'+'<div class="modal-header">'+'<button type="button" class="close" data-dismiss="modal">'+'<span>&times;</span>'+'</button>'+'<h4 class="modal-title">'+gettext('Thank you for your download')+'</h4>'+'</div>'+'<div class="modal-body">'+'<% if (request.get("is_locked")) { %>'+'<div class="alert alert-danger text-center">'+'<strong>'+
gettext('We are having trouble with your last request.')+'</strong>'+'<br/>'+'<%= request.support_text() %>'+'</div>'+'<% } else { %>'+'<% if (!request.get("is_ready")) { %>'+'<h3 class="text-center">'+
gettext('Please be patient, your download is processing')+'</h3>'+'<% } %>'+'<ul class="list-inline text-center">'+'<% _.each(request.get("downloads"), function (download) { %>'+'<li class="img-thumbnail<% print(download.is_ready ? "" : " loading") %>">'+'<img src="<%= download.src %>" />'+'</li>'+'<% }); %>'+'</ul>'+'<% if (request.get("extra_html")) { %>'+'<%= request.get("extra_html") %>'+'<% } %>'+'<% } %>'+'</div>'+'<% if (!request.get("is_locked")) { %>'+'<div class="modal-footer">'+'<% if (request.get("is_ready")) { %>'+'<%= request.footer_text() %>'+'<% } else { %>'+'<span class="text-bold">'+
gettext('Processing')+'...&nbsp;'+'</span>'+'<span class="cspicon cspicon-spin icon-refresh"></span>'+'<% } %>'+'</div>'+'<% } %>'+'</div>'+'</div>'),initialize:function(options){this.listenTo(this.model,'sync',_.bind(this.sync,this));this.$el.modal({show:false});},sync:function(model,resp,options){if(this.model.get('is_ready')&&!this.model.get('is_locked')){var url=this.model.get('url');if(bowser.ios||bowser.android){window.open(url);window.focus();}else if(bowser.mobile){window.location(url);}else{$('<iframe />').hide().attr('src',url).appendTo('body');}}
this.render();},render:function(){var html=this.template({request:this.model});this.$el.html(html);},show:function(){$('body').append(this.$el);this.model.start_polling();this.$el.modal('show');this.render();},hide:function(event){this.model.stop_polling();this.$el.detach();}});var DownloadView=Backbone.View.extend({events:{'click':'click'},initialize:function(options){this.modal=new csp.DownloadRequestView({model:new csp.DownloadRequestModel({downloads:[options.data]})});},click:function(event){this.modal.show();}});$.fn.download=function(params){return this.each(function(){if(!$(this).data('dl')){var options=_.extend(params||{},{el:$(this)});options['data']=$(this).data('download');$(this).data('dl',new DownloadView(options));}});};var DownloadsView=Backbone.View.extend({events:{'change thead input[type="checkbox"]':'toggle','change tbody input[type="checkbox"]':'update','submit':'submit'},toggle:function(event){var checked=this.$(event.currentTarget).is(':checked');this.$('tbody input[type="checkbox"]').prop('checked',checked).trigger('change');},update:function(event){var not_checked=this.$('tbody input[type="checkbox"]:not(:checked)').length,checked=this.$('tbody input[type="checkbox"]:checked').length;this.$('thead input[type="checkbox"]').prop('checked',(not_checked==0));this.$('thead button').prop('disabled',(checked==0));},submit:function(event){event.preventDefault();var downloads=[];this.$('input[data-download]:checked').each(function(idx,elem){downloads.push($(elem).data('download'));});(new csp.DownloadRequestView({model:new csp.DownloadRequestModel({downloads:downloads})})).show();}});$.fn.downloads=function(params){return this.each(function(){if(!$(this).data('dls')){var options=_.extend(params||{},{el:$(this)});$(this).data('dls',new DownloadsView(options));}});};})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,undefined){var RelatedSliderView=Backbone.View.extend({template:_.template('<li>'+'<a href="<%= model.get(\'url\') %>" class="thumb-preview thumb-favorites">'+'<span class="thumb-mask"></span>'+'<img<%= model.get(\'data\') %>/>'+'</a>'+'</li>'),initialize:function(options){var html='';this.collection.each(function(model){html+=this.template({model:model});},this);this.$('ul').html(html);this.$el.slider({maxWidth:180,center:true,height:120});}});csp.RelatedView=Backbone.View.extend({template:_.template('<div class="related-<%= group %>">'+'<h3>'+'<span><%= text %><span>'+'<small class="pull-right">'+'<a href="<%= url %>"><%= see_all %></a>'+'</small>'+'</h3>'+'<div class="slider">'+'<ul></ul>'+'</div>'+'</div>'),initialize:function(options){var load=_.bind(this.load,this,options.image_id);(document.readyState!='complete')?$(window).load(load):load();},load:function(image_id){$.ajax({success:_.bind(this.success,this),url:jslink({viewname:'image:related',kwargs:{image_id:image_id}}),traditional:true});},success:function(data){var html='';_.each(data,function(related,group){html+=this.template({see_all:gettext('See All'),text:related.title,url:related.url,group:group});},this);this.$el.html(html);_.each(data,function(related,group){new RelatedSliderView({el:this.$('div.related-'+group+' div.slider'),collection:new Backbone.Collection(related.images)});},this);Backbone.trigger('related:loaded');}});})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,undefined){csp.DetailRouter=Backbone.Router.extend({initialize:function(){this.route(new RegExp('^(.+)$'),'all');this.on('route:all',_.bind(this.load,this));Backbone.history.start({hashChange:false,pushState:true,silent:true});},load:function(url){window.location.href='/'+url;}});})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,undefined){var FormView=Backbone.View.extend({events:{'change input[name="display_size"]':'display','click span.view-addons':'toggle','change tbody input':'update','click tbody tr':'select','submit':'submit'},initialize:function(options){this.$('tr td span[data-modal]').on('click',AjaxModalView.onClick);this.update();},toggle:function(event){this.$('span.view-addons').remove();this.$('tbody.addons').show();},select:function(event){if(this.$(event.target).is('input'))return;var $input=this.$(event.currentTarget).find('input:not(:disabled)'),checked=$input.is(':radio')?true:!$input.is(':checked');$input.prop('checked',checked).trigger('change');event.stopPropagation();event.preventDefault();},display:function(event){var mode=this.$('input[name="display_size"]:checked').val();this.$('span.px,span.cm,span.in').hide();this.$('span.'+mode).show();},total:function(){var cash=0,credits=0;this.$('tbody tr input[data-cash]:checked').each(function(idx,elem){credits+=parseFloat($(elem).data('credits'));cash+=parseFloat($(elem).data('cash'));});return{cash:format_price(cash),credits:credits};},can_buy_with_subscription:function(){var data=this.$el.serializeObject();return csp.user.has_subscription(data);},can_buy_with_credits:function(){return csp.user.has_credits(this.total().credits);},update:function(){var total=this.total(),has_credits=csp.user.has_credits(1),can_credits_buy=this.can_buy_with_credits(),can_subscription_buy=this.can_buy_with_subscription(),amount=(has_credits)?total.credits:total.cash;this.$('div.purchase-total').toggleClass('danger',(has_credits&&!can_credits_buy));this.$('div.purchase-terms').toggle(can_credits_buy||can_subscription_buy);this.$('div.purchase-total').toggle(!can_subscription_buy);this.$('tbody tr.active').removeClass('active');this.$('tbody tr input:checked').closest('tr').addClass('active');var text=interpolate(gettext('Total: %(amount)s'),{amount:'<span>'+amount+'</span>'},true);this.$('div.purchase-total').html(text);},submit:function(event){var $loading=$('<span/>').html('<span class="cspicon icon-refresh cspicon-spin"></span>'+
gettext('Processing')+'...');if(!this.can_buy_with_subscription()&&!this.can_buy_with_credits()){this.$('button.btn-download').html($loading).attr('disabled',true);return true;}
if(!this.$('input[name="accept"]').is(':checked')){toastr.error(gettext('You must agree to our license terms in order to download this file.'),gettext('Error'),{timeOut:5000});}else{this.$('button.btn-download').html($loading).attr('disabled',true);$.ajax({success:_.bind(this.success,this),data:this.$el.serializeObject(),url:location.href,method:'POST'});}
return false;},success:function(data){if(data.success){(new csp.DownloadRequestView({model:new csp.DownloadRequestModel({downloads:[data]})})).show();}else{toastr.error(gettext('We are having trouble with your last request.'),gettext('Error'),{timeOut:5000});}}});var Detail=Backbone.View.extend({initialize:function(options){this.options=options;this._resize=_.throttle(_.bind(this.resize,this),500);$(window).on('resize',this._resize);if(this.options.enable_router){new csp.DetailRouter();}
this.form=new FormView({el:this.$('form.purchase')});new csp.RelatedView({el:this.$('div.image-related'),image_id:this.options.image_id});if(this.options.zoom_sizes.length>0){this.$('div.zoom-view').zoom({message:gettext('Sorry, you have reached your zoom limit for this image. Thank you.'),sizes:this.options.zoom_sizes,id:this.options.image_id});}
this.$('label span[data-modal]').on('click',AjaxModalView.onClick);this.resize();},resize:function(event){this.form.$el.appendTo(($(window).width()<977)?'#purchase_mobile':'#purchase_full');},remove:function(){Backbone.View.prototype.remove.apply(this,arguments);$(window).off('resize',this._resize);}});$.fn.detail=function(options,enable_router){return this.each(function(){if(!$(this).data('detail')){var params=_.extend(options||{},{enable_router:enable_router,el:$(this)});$(this).data('detail',new Detail(params));}});};})(window.canstockphoto=window.canstockphoto||{},jQuery);