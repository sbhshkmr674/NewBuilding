;(function(global,$){var Zoom={};Zoom.VERSION='2.0.0';Zoom.LOGGER=log.getLogger('zoom');Zoom.Scales=function(options){this.initialize.apply(this,arguments);this.idx=0;};Zoom.Scales.prototype=Array.prototype;_.extend(Zoom.Scales.prototype,Backbone.Events,{initialize:function(options){this.listenTo(options.view,'reset',this.reset);var prev_scale=1,long_side=Math.max(options.width,options.height);_.each(options.sizes,function(size){var scale=(size.size/long_side);this.push({adjust:(scale/prev_scale),display:size.name,scale:scale});prev_scale=scale;},this);},current:function(){return this[this.idx-1];},next:function(){return this[this.idx];},params:function(){return{scale:this.next().scale};},increment:function(){this.idx++;},reset:function(){this.idx=0;},hasNext:function(){return(this.idx<this.length);}});Zoom.Box=Backbone.View.extend({tagName:'div',className:'zoom-box',offset:{left:0,top:0},initialize:function(options){this.view=options.view;this.view.$el.on('mousemove',_.throttle(_.bind(this.mousemove,this),25));this.view.$el.on('mouseenter',_.bind(this.mouseenter,this));this.view.$el.on('mouseleave',_.bind(this.mouseleave,this));this.listenTo(this.view,'reset',this.reset,this);this.listenTo(this.view,'loading',this.loading,this);this.listenTo(this.view,'load',this.load,this);this.offset.left=this.offset.top=0;this.setup();},setup:function(){var scale=this.view.scales.next();this.$el.width(Math.floor(this.view.width/scale.adjust));this.$el.height(Math.floor(this.view.height/scale.adjust));this.data={max_left:(this.view.width-this.$el.outerWidth()),max_top:(this.view.height-this.$el.outerHeight()),center_left:(this.$el.width()/2),center_top:(this.$el.height()/2)};if(this.view.$el.is(':hover'))this.mouseenter();},mousemove:function(event){var offset=this.view.$el.offset();var mouseLeft=Math.floor(event.clientX-offset.left+$(document).scrollLeft()),mouseTop=Math.floor(event.clientY-offset.top+$(document).scrollTop());this.$el.css({left:Math.max(Math.min((mouseLeft-this.data.center_left),this.data.max_left),0),top:Math.max(Math.min((mouseTop-this.data.center_top),this.data.max_top),0)});},mouseenter:function(event){if(this.view.scales.hasNext()){this.$el.show();}},mouseleave:function(event){this.$el.hide();},params:function(){return{left:this.offset.left,top:this.offset.top};},loading:function(event){var position=this.$el.position();var scale=this.view.scales.next();this.offset.left=parseInt((this.offset.left+position.left)*scale.adjust);this.offset.top=parseInt((this.offset.top+position.top)*scale.adjust);this.$el.hide();},load:function(event){if(this.view.scales.hasNext()){if(this.view.$el.is(':hover'))this.$el.show();this.setup();}},reset:function(event){this.offset.left=this.offset.top=0;this.setup();}});Zoom.Details=Backbone.View.extend({tagName:'div',className:'zoom-details',initialize:function(options){this.view=options.view;this.listenTo(this.view,'reset',this.reset);this.listenTo(this.view,'load',this.load);},reset:function(){this.$el.hide();},load:function(){var scale=this.view.scales.current();this.$el.html(scale.display).show();}});Zoom.Loading=Backbone.View.extend({tagName:'div',className:'zoom-loading',initialize:function(options){this.view=options.view;this.listenTo(this.view,'load reset',this.load);this.listenTo(this.view,'loading',this.loading);},loading:function(event){this.$el.show();},load:function(){this.$el.hide();}});Zoom.Image=Backbone.View.extend({tagName:'img',className:'zoom-img',events:{'error':'error','load':'load'},initialize:function(options){this.view=options.view;this.listenTo(this.view,'reset',this.reset);},reset:function(event){this.$el.hide();},error:function(event){this.trigger('error');},load:function(event){this.view.trigger('load');this.$el.show();}});Zoom.View=Backbone.View.extend({defaults:{message:'Zoom Error',url:'/zoom/'},events:{'mouseup':'mouseup'},initialize:function(options){_.bindAll(this,'setup','reset');_.defaults(this,options,this.defaults);$(document).on('mouseup',this.reset);this.$('img').each(_.bind(function(idx,el){if(el.complete)this.setup();},this)).on('load',this.setup);},setup:function(){this.width=this.$el.width();this.height=this.$el.height();Zoom.LOGGER.info('Zoom Width:'+this.width+' Zoom Height:'+this.height);this.scales=new Zoom.Scales({height:this.height,width:this.width,sizes:this.sizes,view:this});this.box_view=new Zoom.Box({view:this});this.$el.append(this.box_view.$el);this.image_view=new Zoom.Image({view:this});this.$el.append(this.image_view.$el);this.details_view=new Zoom.Details({view:this});this.$el.append(this.details_view.$el);this.loading_view=new Zoom.Loading({view:this});this.$el.append(this.loading_view.$el);this.listenTo(this.image_view,'error',this.error);},mouseup:function(event){event.stopPropagation();if(this.scales.hasNext()){this.zoom(event);}else{this.reset(event);}},params:function(){return _.extend({height:this.height,width:this.width,id:this.id,_ts:_.now()},this.scales.params(),this.box_view.params());},zoom:function(event){this.trigger('loading');var params=this.params();Zoom.LOGGER.info('Zoom Params:',params);this.image_view.$el.attr('src',this.url+'?'+$.param(params));this.scales.increment();},reset:function(event){this.trigger('reset');},error:function(){Zoom.LOGGER.info('Zoom Error:',arguments);this.reset();this.details_view.remove();this.loading_view.remove();this.image_view.remove();this.box_view.remove();this.undelegateEvents();this.$el.append('<div class="zoom-message">'+'<div class="zoom-error">'+'<p>'+this.message+'</p>'+'</div>'+'</div>');$(document).on('mouseup',_.bind(function(){this.$('div.zoom-message').remove();},this));}});global.Zoom=Zoom;$.fn.zoom=function(options){return this.each(function(){if(!$(this).data('zoom')){$(this).data('zoom',new Zoom.View(_.extend({el:$(this)},options)));}});};}(this,jQuery));;(function(csp,$,undefined){csp.DownloadRequestModel=Backbone.Model.extend({xhr:null,defaults:{extra_html:null,is_locked:false,is_ready:false,downloads:[],url:null},is_polling:false,initialize:function(attributes,options){this.on('sync',_.bind(this.polling,this));},start_polling:function(){this.is_polling=true;this.fetch();},stop_polling:function(){this.is_polling=false;if(this.xhr)this.xhr.abort();},polling:function(model,resp,options){if(!this.get('is_locked')&&!this.get('is_ready')&&this.is_polling){_.delay(_.bind(this.fetch,this),1000);}},sync:function(method,model,options){if(this.xhr)this.xhr.abort();_.defaults(options||(options={}),{contentType:'application/json; charset=UTF-8',method:'POST',headers:{'X-CSRFToken':Cookies.get('csrftoken')},data:JSON.stringify(model),url:jslink({'viewname':'download:api'})});this.xhr=$.ajax(options);return this.xhr;},footer_text:function(){var text=gettext('Your download should start automatically, if it does not please click %(link_start)shere%(link_end)s.');return interpolate(text,{link_start:'<a href="'+this.get('url')+'">',link_end:'</a>'},true);},support_text:function(){var text=gettext('Please contact %(link_start)ssupport%(link_end)s if this problem persists.');return interpolate(text,{link_start:'<a href="/support.php?md12=true">',link_end:'</a>'},true);}});csp.DownloadRequestView=Backbone.View.extend({tagName:'div',className:'download-modal modal fade',events:{'hidden.bs.modal':'hide'},template:_.template('<div class="modal-dialog">'+'<div class="modal-content">'+'<div class="modal-header">'+'<button type="button" class="close" data-dismiss="modal">'+'<span>&times;</span>'+'</button>'+'<h4 class="modal-title">'+gettext('Thank you for your download')+'</h4>'+'</div>'+'<div class="modal-body">'+'<% if (request.get("is_locked")) { %>'+'<div class="alert alert-danger text-center">'+'<strong>'+
gettext('We are having trouble with your last request.')+'</strong>'+'<br/>'+'<%= request.support_text() %>'+'</div>'+'<% } else { %>'+'<% if (!request.get("is_ready")) { %>'+'<h3 class="text-center">'+
gettext('Please be patient, your download is processing')+'</h3>'+'<% } %>'+'<ul class="list-inline text-center">'+'<% _.each(request.get("downloads"), function (download) { %>'+'<li class="img-thumbnail<% print(download.is_ready ? "" : " loading") %>">'+'<img src="<%= download.src %>" />'+'</li>'+'<% }); %>'+'</ul>'+'<% if (request.get("extra_html")) { %>'+'<%= request.get("extra_html") %>'+'<% } %>'+'<% } %>'+'</div>'+'<% if (!request.get("is_locked")) { %>'+'<div class="modal-footer">'+'<% if (request.get("is_ready")) { %>'+'<%= request.footer_text() %>'+'<% } else { %>'+'<span class="text-bold">'+
gettext('Processing')+'...&nbsp;'+'</span>'+'<span class="cspicon cspicon-spin icon-refresh"></span>'+'<% } %>'+'</div>'+'<% } %>'+'</div>'+'</div>'),initialize:function(options){this.listenTo(this.model,'sync',_.bind(this.sync,this));this.$el.modal({show:false});},sync:function(model,resp,options){if(this.model.get('is_ready')&&!this.model.get('is_locked')){var url=this.model.get('url');if(bowser.ios||bowser.android){window.open(url);window.focus();}else if(bowser.mobile){window.location(url);}else{$('<iframe />').hide().attr('src',url).appendTo('body');}}
this.render();},render:function(){var html=this.template({request:this.model});this.$el.html(html);},show:function(){$('body').append(this.$el);this.model.start_polling();this.$el.modal('show');this.render();},hide:function(event){this.model.stop_polling();this.$el.detach();}});var DownloadView=Backbone.View.extend({events:{'click':'click'},initialize:function(options){this.modal=new csp.DownloadRequestView({model:new csp.DownloadRequestModel({downloads:[options.data]})});},click:function(event){this.modal.show();}});$.fn.download=function(params){return this.each(function(){if(!$(this).data('dl')){var options=_.extend(params||{},{el:$(this)});options['data']=$(this).data('download');$(this).data('dl',new DownloadView(options));}});};var DownloadsView=Backbone.View.extend({events:{'change thead input[type="checkbox"]':'toggle','change tbody input[type="checkbox"]':'update','submit':'submit'},toggle:function(event){var checked=this.$(event.currentTarget).is(':checked');this.$('tbody input[type="checkbox"]').prop('checked',checked).trigger('change');},update:function(event){var not_checked=this.$('tbody input[type="checkbox"]:not(:checked)').length,checked=this.$('tbody input[type="checkbox"]:checked').length;this.$('thead input[type="checkbox"]').prop('checked',(not_checked==0));this.$('thead button').prop('disabled',(checked==0));},submit:function(event){event.preventDefault();var downloads=[];this.$('input[data-download]:checked').each(function(idx,elem){downloads.push($(elem).data('download'));});(new csp.DownloadRequestView({model:new csp.DownloadRequestModel({downloads:downloads})})).show();}});$.fn.downloads=function(params){return this.each(function(){if(!$(this).data('dls')){var options=_.extend(params||{},{el:$(this)});$(this).data('dls',new DownloadsView(options));}});};})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,undefined){var RelatedSliderView=Backbone.View.extend({template:_.template('<li>'+'<a href="<%= model.get(\'url\') %>" class="thumb-preview thumb-favorites">'+'<span class="thumb-mask"></span>'+'<img<%= model.get(\'data\') %>/>'+'</a>'+'</li>'),initialize:function(options){var html='';this.collection.each(function(model){html+=this.template({model:model});},this);this.$('ul').html(html);this.$el.slider({maxWidth:180,center:true,height:120});}});csp.RelatedView=Backbone.View.extend({template:_.template('<div class="related-<%= group %>">'+'<h3>'+'<span><%= text %><span>'+'<small class="pull-right">'+'<a href="<%= url %>"><%= see_all %></a>'+'</small>'+'</h3>'+'<div class="slider">'+'<ul></ul>'+'</div>'+'</div>'),initialize:function(options){var load=_.bind(this.load,this,options.image_id);(document.readyState!='complete')?$(window).load(load):load();},load:function(image_id){$.ajax({success:_.bind(this.success,this),url:jslink({viewname:'image:related',kwargs:{image_id:image_id}}),traditional:true});},success:function(data){var html='';_.each(data,function(related,group){html+=this.template({see_all:gettext('See All'),text:related.title,url:related.url,group:group});},this);this.$el.html(html);_.each(data,function(related,group){new RelatedSliderView({el:this.$('div.related-'+group+' div.slider'),collection:new Backbone.Collection(related.images)});},this);Backbone.trigger('related:loaded');}});})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,undefined){csp.DetailRouter=Backbone.Router.extend({initialize:function(){this.route(new RegExp('^(.+)$'),'all');this.on('route:all',_.bind(this.load,this));Backbone.history.start({hashChange:false,pushState:true,silent:true});},load:function(url){window.location.href='/'+url;}});})(window.canstockphoto=window.canstockphoto||{},jQuery);;(function(csp,$,undefined){var FormView=Backbone.View.extend({events:{'change input[name="display_size"]':'display','click span.view-addons':'toggle','change tbody input':'update','click tbody tr':'select','submit':'submit'},initialize:function(options){this.$('tr td span[data-modal]').on('click',AjaxModalView.onClick);this.update();},toggle:function(event){this.$('span.view-addons').remove();this.$('tbody.addons').show();},select:function(event){if(this.$(event.target).is('input'))return;var $input=this.$(event.currentTarget).find('input:not(:disabled)'),checked=$input.is(':radio')?true:!$input.is(':checked');$input.prop('checked',checked).trigger('change');event.stopPropagation();event.preventDefault();},display:function(event){var mode=this.$('input[name="display_size"]:checked').val();this.$('span.px,span.cm,span.in').hide();this.$('span.'+mode).show();},total:function(){var cash=0,credits=0;this.$('tbody tr input[data-cash]:checked').each(function(idx,elem){credits+=parseFloat($(elem).data('credits'));cash+=parseFloat($(elem).data('cash'));});return{cash:format_price(cash),credits:credits};},can_buy_with_subscription:function(){var data=this.$el.serializeObject();return csp.user.has_subscription(data);},can_buy_with_credits:function(){return csp.user.has_credits(this.total().credits);},update:function(){var total=this.total(),has_credits=csp.user.has_credits(1),can_credits_buy=this.can_buy_with_credits(),can_subscription_buy=this.can_buy_with_subscription(),amount=(has_credits)?total.credits:total.cash;this.$('div.purchase-total').toggleClass('danger',(has_credits&&!can_credits_buy));this.$('div.purchase-terms').toggle(can_credits_buy||can_subscription_buy);this.$('div.purchase-total').toggle(!can_subscription_buy);this.$('tbody tr.active').removeClass('active');this.$('tbody tr input:checked').closest('tr').addClass('active');var text=interpolate(gettext('Total: %(amount)s'),{amount:'<span>'+amount+'</span>'},true);this.$('div.purchase-total').html(text);},submit:function(event){var $loading=$('<span/>').html('<span class="cspicon icon-refresh cspicon-spin"></span>'+
gettext('Processing')+'...');if(!this.can_buy_with_subscription()&&!this.can_buy_with_credits()){this.$('button.btn-download').html($loading).attr('disabled',true);return true;}
if(!this.$('input[name="accept"]').is(':checked')){toastr.error(gettext('You must agree to our license terms in order to download this file.'),gettext('Error'),{timeOut:5000});}else{this.$('button.btn-download').html($loading).attr('disabled',true);$.ajax({success:_.bind(this.success,this),data:this.$el.serializeObject(),url:location.href,method:'POST'});}
return false;},success:function(data){if(data.success){(new csp.DownloadRequestView({model:new csp.DownloadRequestModel({downloads:[data]})})).show();}else{toastr.error(gettext('We are having trouble with your last request.'),gettext('Error'),{timeOut:5000});}}});var Detail=Backbone.View.extend({initialize:function(options){this.options=options;this._resize=_.throttle(_.bind(this.resize,this),500);$(window).on('resize',this._resize);if(this.options.enable_router){new csp.DetailRouter();}
this.form=new FormView({el:this.$('form.purchase')});new csp.RelatedView({el:this.$('div.image-related'),image_id:this.options.image_id});if(this.options.zoom_sizes.length>0){this.$('div.zoom-view').zoom({message:gettext('Sorry, you have reached your zoom limit for this image. Thank you.'),sizes:this.options.zoom_sizes,id:this.options.image_id});}
this.$('label span[data-modal]').on('click',AjaxModalView.onClick);this.resize();},resize:function(event){this.form.$el.appendTo(($(window).width()<977)?'#purchase_mobile':'#purchase_full');},remove:function(){Backbone.View.prototype.remove.apply(this,arguments);$(window).off('resize',this._resize);}});$.fn.detail=function(options,enable_router){return this.each(function(){if(!$(this).data('detail')){var params=_.extend(options||{},{enable_router:enable_router,el:$(this)});$(this).data('detail',new Detail(params));}});};})(window.canstockphoto=window.canstockphoto||{},jQuery);